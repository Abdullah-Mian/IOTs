/*
 * ESP32 WROOM32 - ESP-NOW Receiver
 * L298N Control: PWM on IN pins only (4 pins total)
 * Works perfectly with Arduino Core 3.x+
 * (No need for ledcWrite â€” uses analogWrite directly)
 */

#include <esp_now.h>
#include <WiFi.h>

// L298N Motor Driver Pins - ONLY 4 PINS NEEDED
// Connect ENA and ENB to 5V directly on L298N board
#define IN1_PIN  13   // Motor A direction 1 (Safe pin)
#define IN2_PIN  14   // Motor A direction 2 (Safe pin)
#define IN3_PIN  16   // Motor B direction 1 (Safe pin, UART2_RX but OK for motor)
#define IN4_PIN  17   // Motor B direction 2 (Safe pin, UART2_TX but OK for motor)

bool ForwardGear = true;
int speed = 200;

// Structure to receive data
typedef struct struct_message {
  char command;
} struct_message;

struct_message incomingData;


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Motor control functions
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
void moveForward() {
  Serial.println("â¬†ï¸  FORWARD");
  analogWrite(IN1_PIN, speed);
  analogWrite(IN2_PIN, 0);
  analogWrite(IN3_PIN, 0);
  analogWrite(IN4_PIN, 0);
}

void moveBackward() {
  Serial.println("â¬‡ï¸  BACKWARD");
  analogWrite(IN1_PIN, 0);
  analogWrite(IN2_PIN, speed);
  analogWrite(IN3_PIN, 0);
  analogWrite(IN4_PIN, 0);
}

void turnLeft() {
  Serial.println("â¬…ï¸  LEFT");
  if(ForwardGear){
    analogWrite(IN1_PIN, speed);
    analogWrite(IN2_PIN, 0);
  }else{
    analogWrite(IN1_PIN, 0);
    analogWrite(IN2_PIN, speed);
  }
  analogWrite(IN3_PIN, speed);
  analogWrite(IN4_PIN, 0);
}

void turnRight() {
  Serial.println("â¡ï¸  RIGHT");
  if(ForwardGear){
    analogWrite(IN1_PIN, speed);
    analogWrite(IN2_PIN, 0);
  }else{
    analogWrite(IN1_PIN, 0);
    analogWrite(IN2_PIN, speed);
  }
  analogWrite(IN3_PIN, 0);
  analogWrite(IN4_PIN, speed);
}

void stopMotors() {
  Serial.println("ğŸ›‘ STOP");
  analogWrite(IN1_PIN, 0);
  analogWrite(IN2_PIN, 0);
  analogWrite(IN3_PIN, 0);
  analogWrite(IN4_PIN, 0);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ESP-NOW Data Receive Callback
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
void OnDataRecv(const esp_now_recv_info_t *recv_info, const uint8_t *data, int len) {
  memcpy(&incomingData, data, sizeof(incomingData));
  
  Serial.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.print("â•‘ ğŸ“¥ Command: ");
  Serial.print(incomingData.command);
  
  // Execute motor command
  switch (incomingData.command) {
    case 'W': moveForward(); break;
    case 'B': moveBackward(); break;
    case 'A': turnLeft(); break;
    case 'D': turnRight(); break;
    case 'X': ForwardGear = !ForwardGear; break;
    case 'S': stopMotors(); break;
    default:  stopMotors(); break;
  }
  
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Setup
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘      ESP32 WROOM32 ESP-NOW Receiver   â•‘");
  Serial.println("â•‘         L298N (4-PIN PWM MODE)        â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  
  // Configure motor control pins
  pinMode(IN1_PIN, OUTPUT);
  pinMode(IN2_PIN, OUTPUT);
  pinMode(IN3_PIN, OUTPUT);
  pinMode(IN4_PIN, OUTPUT);
 
  stopMotors();
  Serial.println("âœ… Motor driver initialized (4-pin mode)");
  Serial.println("âš ï¸  Connect ENA and ENB to 5V on L298N board");
  
  // WiFi setup
  WiFi.mode(WIFI_STA);
  
  // Display MAC address
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘         IMPORTANT: COPY THIS!         â•‘");
  Serial.println("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
  Serial.print("â•‘ ğŸ“ WROOM32 MAC: ");
  Serial.print(WiFi.macAddress());
  Serial.println("  â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("\nâš ï¸  Copy the MAC above and set it as receiverMAC[] in your ESP32-C3 sender code!\n");
  
  // Initialize ESP-NOW
  if (esp_now_init() != ESP_OK) {
    Serial.println("âŒ ESP-NOW Init Failed! Restarting...");
    delay(1000);
    ESP.restart();
  }
  
  Serial.println("âœ… ESP-NOW Initialized");
  
  // Register receive callback
  esp_now_register_recv_cb(OnDataRecv);
  Serial.println("âœ… Receive callback registered");
  Serial.println("\nğŸ® Waiting for commands...\n");
  Serial.println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Main loop
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
void loop() {
  // Auto-stop if no packets received for 2 seconds

}

/*
 * ESP32-C3 Super Mini - Joystick to ESP-NOW Sender
 * Sends W/A/S/D commands via ESP-NOW to WROOM32
 * Controls robot via L298N motor driver
 */

#include <esp_now.h>
#include <WiFi.h>

// IMPORTANT: Replace with your WROOM32's MAC Address
// You'll get this from the WROOM32 code when it starts
uint8_t receiverMAC[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};

// Joystick pins
#define JOY_X_PIN   0  // GPIO0
#define JOY_Y_PIN   1  // GPIO1
#define JOY_BTN_PIN 2  // GPIO2

// Thresholds for direction detection
#define THRESHOLD_LOW  1000
#define THRESHOLD_HIGH 3000

// Variables
int xValue = 0;
int yValue = 0;
char currentCommand = '\0';
char lastCommand = '\0';
unsigned long lastSendTime = 0;
const unsigned long SEND_INTERVAL = 50; // Send every 50ms

// Structure to send data
typedef struct struct_message {
  char command;      // W, A, S, D, X (stop)
  int speed;         // 0-255
  unsigned long timestamp;
} struct_message;

struct_message outgoingData;

// Callback when data is sent
void OnDataSent(const uint8_t *mac_addr, esp_now_send_status_t status) {
  if (status != ESP_NOW_SEND_SUCCESS) {
    Serial.println("âŒ Delivery Failed!");
  }
}

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘  ESP32-C3 Joystick â†’ ESP-NOW Sender  â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  
  // Configure joystick pins
  pinMode(JOY_BTN_PIN, INPUT_PULLUP);
  analogReadResolution(12);
  
  // Set device as WiFi Station
  WiFi.mode(WIFI_STA);
  
  // Print MAC Address
  Serial.print("ðŸ“¡ C3 MAC Address: ");
  Serial.println(WiFi.macAddress());
  Serial.println();
  
  // Initialize ESP-NOW
  if (esp_now_init() != ESP_OK) {
    Serial.println("âŒ ESP-NOW Init Failed!");
    ESP.restart();
  }
  
  Serial.println("âœ… ESP-NOW Initialized");
  
  // Register send callback
  esp_now_register_send_cb(OnDataSent);
  
  // Register peer (WROOM32)
  esp_now_peer_info_t peerInfo;
  memset(&peerInfo, 0, sizeof(peerInfo));
  memcpy(peerInfo.peer_addr, receiverMAC, 6);
  peerInfo.channel = 0;
  peerInfo.encrypt = false;
  
  if (esp_now_add_peer(&peerInfo) != ESP_OK) {
    Serial.println("âŒ Failed to add peer!");
    Serial.println("âš ï¸  Make sure to update receiverMAC with WROOM32's MAC!");
    return;
  }
  
  Serial.println("âœ… Peer added successfully");
  Serial.println("\nðŸŽ® Ready to send commands!\n");
  Serial.println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
}

void loop() {
  // Read joystick values
  xValue = analogRead(JOY_X_PIN);
  yValue = analogRead(JOY_Y_PIN);
  
  // Determine command based on joystick position
  currentCommand = 'X'; // Default: STOP
  int speed = 200; // Default speed (0-255)
  
  // Check vertical movement first (forward/backward)
  if (yValue > THRESHOLD_HIGH) {
    currentCommand = 'W'; // FORWARD
    speed = map(yValue, THRESHOLD_HIGH, 4095, 150, 255);
  } 
  else if (yValue < THRESHOLD_LOW) {
    currentCommand = 'S'; // BACKWARD
    speed = map(yValue, THRESHOLD_LOW, 0, 150, 255);
  }
  // Check horizontal movement (turn)
  else if (xValue < THRESHOLD_LOW) {
    currentCommand = 'A'; // LEFT
    speed = map(xValue, THRESHOLD_LOW, 0, 150, 255);
  }
  else if (xValue > THRESHOLD_HIGH) {
    currentCommand = 'D'; // RIGHT
    speed = map(xValue, THRESHOLD_HIGH, 4095, 150, 255);
  }
  
  // Button press - emergency stop
  if (digitalRead(JOY_BTN_PIN) == LOW) {
    currentCommand = 'X'; // STOP
    speed = 0;
  }
  
  // Send data if command changed OR interval elapsed
  unsigned long currentTime = millis();
  bool shouldSend = false;
  
  if (currentCommand != lastCommand) {
    shouldSend = true;
  } else if (currentTime - lastSendTime >= SEND_INTERVAL) {
    shouldSend = true;
  }
  
  if (shouldSend) {
    outgoingData.command = currentCommand;
    outgoingData.speed = speed;
    outgoingData.timestamp = currentTime;
    
    // Send via ESP-NOW
    esp_err_t result = esp_now_send(receiverMAC, (uint8_t *)&outgoingData, sizeof(outgoingData));
    
    if (result == ESP_OK) {
      Serial.print("ðŸ“¤ Sent: ");
      Serial.print(currentCommand);
      Serial.print(" | Speed: ");
      Serial.print(speed);
      Serial.print(" | X:");
      Serial.print(xValue);
      Serial.print(" Y:");
      Serial.println(yValue);
    }
    
    lastCommand = currentCommand;
    lastSendTime = currentTime;
  }
  
  delay(10);
}
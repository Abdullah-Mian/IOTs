/*
 * ESP32 WROOM32 - ESP-NOW Receiver
 * L298N Control: PWM on IN pins only (4 pins total)
 * Works perfectly with Arduino Core 3.x+
 * (No need for ledcWrite ‚Äî uses analogWrite directly)
 */

#include <esp_now.h>
#include <WiFi.h>

// L298N Motor Driver Pins - ONLY 4 PINS NEEDED
// Connect ENA and ENB to 5V directly on L298N board
#define IN1_PIN  27   // Motor A direction 1
#define IN2_PIN  26   // Motor A direction 2
#define IN3_PIN  25   // Motor B direction 1
#define IN4_PIN  33   // Motor B direction 2

#define LED_PIN  2

const int stopDelay = 100;     // Safety delay in loop
int speed = 200;

// Structure to receive data
typedef struct struct_message {
  char command;
  int speed;
  unsigned long timestamp;
} struct_message;

struct_message incomingData;

// Statistics
unsigned long packetsReceived = 0;
unsigned long lastPacketTime = 0;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Motor control functions
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
void moveForward(int speed) {
  Serial.println("‚¨ÜÔ∏è  FORWARD");
  analogWrite(IN1_PIN, speed);
  analogWrite(IN2_PIN, 0);
  analogWrite(IN3_PIN, speed);
  analogWrite(IN4_PIN, 0);
}

void moveBackward(int speed) {
  Serial.println("‚¨áÔ∏è  BACKWARD");
  analogWrite(IN1_PIN, 0);
  analogWrite(IN2_PIN, speed);
  analogWrite(IN3_PIN, 0);
  analogWrite(IN4_PIN, speed);
}

void turnLeft(int speed) {
  Serial.println("‚¨ÖÔ∏è  LEFT");
  analogWrite(IN1_PIN, speed);
  analogWrite(IN2_PIN, 0);
  analogWrite(IN3_PIN, 0);
  analogWrite(IN4_PIN, speed);
}

void turnRight(int speed) {
  Serial.println("‚û°Ô∏è  RIGHT");
  analogWrite(IN1_PIN, 0);
  analogWrite(IN2_PIN, speed);
  analogWrite(IN3_PIN, speed);
  analogWrite(IN4_PIN, 0);
}

void stopMotors() {
  Serial.println("üõë STOP");
  analogWrite(IN1_PIN, 0);
  analogWrite(IN2_PIN, 0);
  analogWrite(IN3_PIN, 0);
  analogWrite(IN4_PIN, 0);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ESP-NOW Data Receive Callback
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
void OnDataRecv(const esp_now_recv_info_t *recv_info, const uint8_t *data, int len) {
  memcpy(&incomingData, data, sizeof(incomingData));
  
  packetsReceived++;
  unsigned long currentTime = millis();
  unsigned long latency = currentTime - incomingData.timestamp;
  
  digitalWrite(LED_PIN, HIGH);
  
  Serial.println("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
  Serial.print("‚ïë üì• Command: ");
  Serial.print(incomingData.command);
  Serial.print(" | Speed: ");
  Serial.print(incomingData.speed);
  Serial.println("      ‚ïë");
  Serial.print("‚ïë ‚è±Ô∏è  Latency: ");
  Serial.print(latency);
  Serial.println(" ms                 ‚ïë");
  Serial.print("‚ïë üìä Packets: ");
  Serial.print(packetsReceived);
  Serial.println("                    ‚ïë");
  Serial.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
  
  // Execute motor command
  switch (incomingData.command) {
    case 'W': moveForward(incomingData.speed); break;
    case 'S': moveBackward(incomingData.speed); break;
    case 'A': turnLeft(incomingData.speed); break;
    case 'D': turnRight(incomingData.speed); break;
    case 'X':
    default:  stopMotors(); break;
  }

  Serial.println();
  
  lastPacketTime = currentTime;
  digitalWrite(LED_PIN, LOW);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Setup
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
  Serial.println("‚ïë      ESP32 WROOM32 ESP-NOW Receiver   ‚ïë");
  Serial.println("‚ïë         L298N (4-PIN PWM MODE)        ‚ïë");
  Serial.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n");
  
  // Configure LED
  pinMode(LED_PIN, OUTPUT);
  digitalWrite(LED_PIN, LOW);
  
  // Configure motor control pins
  pinMode(IN1_PIN, OUTPUT);
  pinMode(IN2_PIN, OUTPUT);
  pinMode(IN3_PIN, OUTPUT);
  pinMode(IN4_PIN, OUTPUT);
 
  stopMotors();
  Serial.println("‚úÖ Motor driver initialized (4-pin mode)");
  Serial.println("‚ö†Ô∏è  Connect ENA and ENB to 5V on L298N board");
  
  // WiFi setup
  WiFi.mode(WIFI_STA);
  
  // Display MAC address
  Serial.println("\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
  Serial.println("‚ïë         IMPORTANT: COPY THIS!         ‚ïë");
  Serial.println("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£");
  Serial.print("‚ïë üìç WROOM32 MAC: ");
  Serial.print(WiFi.macAddress());
  Serial.println("  ‚ïë");
  Serial.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
  Serial.println("\n‚ö†Ô∏è  Copy the MAC above and set it as receiverMAC[] in your ESP32-C3 sender code!\n");
  
  // Initialize ESP-NOW
  if (esp_now_init() != ESP_OK) {
    Serial.println("‚ùå ESP-NOW Init Failed! Restarting...");
    delay(1000);
    ESP.restart();
  }
  
  Serial.println("‚úÖ ESP-NOW Initialized");
  
  // Register receive callback
  esp_now_register_recv_cb(OnDataRecv);
  Serial.println("‚úÖ Receive callback registered");
  Serial.println("\nüéÆ Waiting for commands...\n");
  Serial.println("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Main loop
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
void loop() {
  // Auto-stop if no packets received for 2 seconds
  if (packetsReceived > 0 && (millis() - lastPacketTime > 2000)) {
    static unsigned long lastWarning = 0;
    if (millis() - lastWarning > 1000) {
      stopMotors();
      Serial.println("‚ö†Ô∏è  Connection lost - Motors stopped!");
      lastWarning = millis();
    }
  }

  delay(stopDelay);
}
